#summary Persistence Object Storage (POS), prototype
#labels Phase-Design

The idea is to create a flexible storage of PHP objects in the DB, without the necessity to create many tables for them. Even bigger strategic goal is to create a good platform for "application server"-like applications in PHP.

To implement this functionality the FaZend_POS class will automatically create DB table: `fz_pos`. Everything will be stored in one table (_this is the idea so far_).

= Usage samples =

You create a new object and assign it to the storage (POS):

{{{
class Car extends FaZend_POS_Abstract {
    public function __construct() {
        parent::__construct();
        $this->color = 'white';
        $this->model = false;
    }
    public function isGermanCar() {
        if ($this->model == 'bmw')
            return true;
        return false;
    }
}

FaZend_POS::root()->bmw328 = new Car();
}}}

You can create a simple object as well:

{{{
$root = FaZend_POS::root();
$root->cars = array(); // throws Exception
$root->cars = new FaZend_POS_Array();
$bmw = new Car();
$root->cars[] = $bmw;
$bmw->color = 'black';
$bwm->model = 'bmw';
}}}

Later, in another part of the application:

{{{
$bmw = current(FaZend_POS::root()->cars);
echo $bmw->isGermanCar(); // returns TRUE
echo FaZend_POS::root()->bmw328i->color; // returns 'white'
}}}

You can delete an object, or wipe it out (delete forever):

{{{
$car = FaZend_POS::root()->bmw328i;
$car->ps()->delete(); // still in storage, but marked as deleted
$car->ps()->wipe(); // wipe it out, no more information in storage about it
}}}

Objects can include objects, and FaZend_POS will understand such links. Objects won't be copied, but symbolic links will be created.

You can create an object of class `FaZend_POS_Bag` and add it to any `FaZend_POS_Abstract` object as a child. In this case any properties you set in the child won't be managed as individual objects, e.g.:

{{{
$car = FaZend_POS::root()->bmw328i;
$car->images = new FaZend_POS_Bag();
$car->images[1] = new BigImage();
// sometime later in another script
$image = $car->images[1]; // no matter what's inside the object
}}}

= Version Control =

Changes are under control, like in Subversion repository:

{{{
$car = FaZend_POS::root()->bmw328i;
$ps = $car->ps(); // FaZend_POS_Properties - system properties of the object
$ps->editor; // FaZend_User with the editor of latest changes
$ps->version; // FaZend_POS_Version of the latest version
$ps->updated; // time when the object was updated last time
$ps->id; // int - unique id of the object in storage
$ps->type; // full name of the class for this object
$ps->parent; // parent object or NULL if it's root already
}}}

You can play with versions:

{{{
$car = FaZend_POS::root()->bmw328i;
$version = $car->ps()->version;
$car->ps()->workWithVersion($version - 1); // now the object has data from previous version
$car->ps()->setTimeBoundary(time() - 60*60); // ignore any changes made during the last hour
$car->ps()->touch(); // increases the version of the object, no other changes
$car->ps()->rollBack($version - 1); // roll back all changes to previous version
$car->ps()->getVersions(10); // returns an array of 10 latest version
$car->ps()->getAge(); // returns object age in storage, in seconds
}}}

= Access Control =

You can setup an access control object, which will be responsible for user access rights management for any particular object. Before any operation `FaZend_POS` will ask this `ACL` whether this operation is permitted or not, giving the object name to it:

{{{
FaZend_POS::root()->ps()->setACL(new Zend_ACL());
}}}

= Objects' Approval =

You can baseline any object and request an approval from other users. They will approve or reject. You can give them a message together with the approval request. Also, you can set the time boundary for the approval (24 hours in the example below).

{{{
$car = FaZend_POS::root()->bmw328i;
$mary = new FaZend_User(13);
$car->ps()->baseline(array($mary), 'please, approve my new car', 24);
}}}

If the list of users is empty - the object becomes baselined AND approved right now.

Later, `Mary` is a current user:

{{{
$car = FaZend_POS::root()->bmw328i;
if ($car->ps()->waitingForApproval()) {
    if ($car->isGermanCar())
        $car->ps()->approve();
    else
        $car->ps()->reject();
}
}}}

You can check the status of the object's approval:

{{{
$car = FaZend_POS::root()->bmw328i;
$car->ps()->isApproved();
$car->ps()->isBaselined();
$car->ps()->isRejected();
}}}

And you can get a list of all objects waiting for user's attention:

{{{
$objects = FaZend_POS::getWaiting($mary);
}}}

= Branching =

You (some user) can create a branch of any object and then work with this branch (at most one branch per user):

{{{
$car = FaZend_POS::root()->bmw328i;
$car->ps()->branch(); // create a new branch for current user (overwrite the existing one, if any)
$car->ps()->revert(); // get back to "trunk"
$car->ps()->commit($user); // commit user's changes to trunk (overwriting existing version) 
$car->ps()->respectBranch(true); // during this session we should work with the branch (default option) or "trunk"
$car->ps()->respectBranch($user); // during this session we should work with this branch (by this user)
}}}

When the object becomes baselined all branches becomes unavailable.

= Other ideas =

 * Maybe `xpath()` search on the full storage is a good option.			
 * Automated cleaning of very old version
 * `exportXML()`, `importXML()`
 * `diff()`